const circomlibjs = require("circomlibjs");
const { MerkleTree } = require("fixed-merkle-tree");

const { leBufferToBigint, hexToBigint } = require("./bigint.js");

// Constants from MerkleTreeWithHistory.sol
const MERKLE_TREE_HEIGHT = 32;

// This matches the zeros function in MerkleTreeWithHistory.sol
const ZERO_VALUES = [
  "202a8f96045740e4004986fd2b650cf51b0cc148fb60f01312e628237deef281",//0:mimcsponge(keccak256("FOOM"),0) 
  "0b2e758743ccfa3862e08c5dd379fd69488aa75ad6af13accc53ba97fcbcb528",//1
  "057c4de8d5a8528665a63b905f0101ff7613414908e90d50d2f0c653dbb715de",//2
  "0e1b6cdd46ad9ffd5e994c864581fdf4de1d591f0b036a7f187ecc98ac7c3cb3",//3
  "0bbeaea623e15c126bc2a79b7721293d8c5819c0c93fc6f4b46d96c8d30310ca",//4
  "2cee490e0f6709557a04c4a64a1b2f07de1334e74cabd9eea3f37f8c1e17e522",//5
  "11cb3f75ae3bf84cf9a02a6c1d8feec18c6e81e34c2cf970985b827a56f5f925",//6
  "2a5e106d6c503d83ac7fcd2680b040813f09d95f5c514873b27bdd564eeea9f9",//7
  "017e8145556b5a426ee6112399ea51d95122a72a988f9e753e9117aa3d973d1b",//8
  "11f5c0dbcc3d321f68cb3cb6c16795c1e08d18fbcc7567d204af1af66ca563eb",//9
  "25d3fdb57ca9a4db85f2347ddf635f99730cd68705a54e27fc9a1d9b25d01d11",//10
  "23dc1234876e354166436513d626df9b3810799dfe523d8717a4c33a137a42c9",//11
  "227e0f15e1ff7d57d9d0e5243675d169d193489d0800c9945959174ba5658154",//12
  "0dffe4520de3d082f56bb106e2924b456f825e922761d749eb1a29afb1f784f9",//13
  "1ffa90c56f39c538f241eba71782e4a69aab0fb43cb968505d35a0f14529a05d",//14
  "2201599ef7782d4d035487ab1467a6f0ce0abe69e5e755710ea10e6f4fe51bfd",//15
  "2f426caa63faba590dbb1c463ef494585f254e373fa6a23567cc9291135ef1a4",//16
  "0b0dcf14ca5e6f9a0660818681d21b6df5bd9075e1945df85d957e061eff565d",//17
  "2ae4465fbe8fd25a39f1e0e289098d1a3b26cd274b0ef4c911974b5f1b5bbe57",//18
  "2111ccd495b2338952afea3a1cf0c7e816333240678b1ebc545007179111e956",//19
  "0316a21cfe5ebf127b1efae4ecfbc476c47db546b13c915efebbf917dbad2a63",//20
  "2fdca0843043698e90deb1b0c52181d8188763ebbd88aa6659df9ffb23aa3bc4",//21
  "04c99043b2be17c6af3e10796d0bf75b08d03f413d4af528b198f200dc832939",//22
  "2ebce6763c7028261ed65d432ceec1a7493969c80bbf426ca9167d80a1c8d963",//23
  "23e42a65648de39e532e24e9050c5355fddb331700a155782c4f3a85b1766b6d",//24
  "2f9db21a4c7ab179efa1cac9fc389084ecc410ed2e7d5426ca5dde18777f5df6",//25
  "25d215bce3087b0d8c6ef120d696ce075b22402dd800fcd53f43c382fe5db539",//26
  "29e89141890d3ed3eaf93345eaf7e73ae777091a61e659ec73ca39e5cfc87163",//27
  "2f3c98cd95ccff391976b8954f9b94b0a1ba61497d64eb9575c9f4d9602431ba",//28
  "0e4a4b68ebb99a1cd97ae3bcd3bc3ed63e9a320069e1799ba6cc5b972677ff73",//29
  "2c1f841238f664dd797957778269fa53c8ecdfd1af0c339219b862bb9770064e",//30
  "2150e5c55045c73f99cacd199d6086e84381f17b861cb0fb73fcc8803c180a59",//31
  "0e70c0ce4936fef410bff8991ee5051bfce7d594013b64aba97369ce4f2e2454",// Root
  /*
  "2fe54c60d3acabf3343a35b6eba15db4821b340f76e741e2249685ed4899af6c",
  "256a6135777eee2fd26f54b8b7037a25439d5235caee224154186d2b8a52e31d",
  "1151949895e82ab19924de92c40a3d6f7bcb60d92b00504b8199613683f0c200",
  "20121ee811489ff8d61f09fb89e313f14959a0f28bb428a20dba6b0b068b3bdb",
  "0a89ca6ffa14cc462cfedb842c30ed221a50a3d6bf022a6a57dc82ab24c157c9",
  "24ca05c2b5cd42e890d6be94c68d0689f4f21c9cec9c0f13fe41d566dfb54959",
  "1ccb97c932565a92c60156bdba2d08f3bf1377464e025cee765679e604a7315c",
  "19156fbd7d1a8bf5cba8909367de1b624534ebab4f0f79e003bccdd1b182bdb4",
  "261af8c1f0912e465744641409f622d466c3920ac6e5ff37e36604cb11dfff80",
  "0058459724ff6ca5a1652fcbc3e82b93895cf08e975b19beab3f54c217d1c007",
  "1f04ef20dee48d39984d8eabe768a70eafa6310ad20849d4573c3c40c2ad1e30",
  "1bea3dec5dab51567ce7e200a30f7ba6d4276aeaa53e2686f962a46c66d511e5",
  "0ee0f941e2da4b9e31c3ca97a40d8fa9ce68d97c084177071b3cb46cd3372f0f",
  "1ca9503e8935884501bbaf20be14eb4c46b89772c97b96e3b2ebf3a36a948bbd",
  "133a80e30697cd55d8f7d4b0965b7be24057ba5dc3da898ee2187232446cb108",
  "13e6d8fc88839ed76e182c2a779af5b2c0da9dd18c90427a644f7e148a6253b6",
  "1eb16b057a477f4bc8f572ea6bee39561098f78f15bfb3699dcbb7bd8db61854",
  "0da2cb16a1ceaabf1c16b838f7a9e3f2a3a3088d9e0a6debaa748114620696ea",
  "24a3b3d822420b14b5d8cb6c28a574f01e98ea9e940551d2ebd75cee12649f9d",
  "198622acbd783d1b0d9064105b1fc8e4d8889de95c4c519b3f635809fe6afc05",
  "29d7ed391256ccc3ea596c86e933b89ff339d25ea8ddced975ae2fe30b5296d4",
  "19be59f2f0413ce78c0c3703a3a5451b1d7f39629fa33abd11548a76065b2967",
  "1ff3f61797e538b70e619310d33f2a063e7eb59104e112e95738da1254dc3453",
  "10c16ae9959cf8358980d9dd9616e48228737310a10e2b6b731c1a548f036c48",
  "0ba433a63174a90ac20992e75e3095496812b652685b5e1a2eae0b1bf4e8fcd1",
  "019ddb9df2bc98d987d0dfeca9d2b643deafab8f7036562e627c3667266a044c",
  "2d3c88b23175c5a5565db928414c66d1912b11acf974b2e644caaac04739ce99",
  "2eab55f6ae4e66e32c5189eed5c470840863445760f5ed7e7b69b2a62600f354",
  "002df37a2642621802383cf952bf4dd1f32e05433beeb1fd41031fb7eace979d",
  "104aeb41435db66c3e62feccc1d6f5d98d0a0ed75d1374db457cf462e3a1f427",
  "1f3c6fd858e9a7d4b0d1f38e256a09d81d5a5e3c963987e2d4b814cfab7c6ebb",
  "2c7a07d20dff79d01fecedc1134284a8d08436606c93693b67e333f671bf69cc",
  */
].map(hexToBigint);

// Creates a fixed height merkle-tree with MiMC hash function (just like MerkleTreeWithHistory.sol)
async function mimicMerkleTree(leaves = []) {
  const pedersen = await circomlibjs.buildPedersenHash(); //TODO, not needed, fromMontgomery is in mimc
  const mimcsponge = await circomlibjs.buildMimcSponge();

  const mimcspongeMultiHash = (left, right) =>
    leBufferToBigint(
      pedersen.babyJub.F.fromMontgomery(mimcsponge.multiHash([left, right]))
    );

  return new MerkleTree(MERKLE_TREE_HEIGHT, leaves, {
    hashFunction: mimcspongeMultiHash,
    zeroElement: ZERO_VALUES[0],
  });
}

module.exports = {
  mimicMerkleTree,
};
